# RSS Feeder 仕様書 (GAS + Obsidian Local REST API)

## 概要
Google Apps Script（GAS）で毎日RSSフィードを取得し、Gemini APIでタグ付けと要約を行い、Obsidian Local REST APIプラグイン経由でObsidian Vaultにマークダウンファイルを作成するシステム

## 前提条件

### Obsidianプラグイン設定
- **Local REST API** プラグインがインストール・有効化済み
- APIキーが設定され、HTTPSエンドポイントが利用可能
- 通常は `https://127.0.0.1:27123` でアクセス可能

### GAS環境
- Google Apps Scriptプロジェクト作成済み
- 定期実行用のトリガー設定

## システム構成

### 1. プロジェクト構造（GAS）
```
RSS-Feeder-GAS/
├── Code.gs              # メインスクリプト
├── Config.gs            # 設定管理
├── FeedFetcher.gs       # RSSフィード取得
├── LLMProcessor.gs      # Gemini API処理
├── ObsidianAPI.gs       # Obsidian REST API連携
└── Utils.gs             # ユーティリティ関数
```

### 2. 設定管理（PropertiesService）
```javascript
// GASのプロパティサービスで管理
const config = {
  "feeds": [
    "https://example.com/rss.xml",
    "https://another-site.com/feed.xml"
  ],
  "gemini_api_key": "YOUR_GEMINI_API_KEY",
  "obsidian_api_url": "https://127.0.0.1:27123",
  "obsidian_api_key": "YOUR_OBSIDIAN_API_KEY",
  "output_directory": "RSS"
}
```

## 処理フロー

### 1. RSSフィード取得
- 設定からフィードURLリストを読み込み
- GASの`UrlFetchApp`で各URLからRSSフィードを取得
- XMLの解析は`XmlService`を使用
- 取得失敗時はログ出力してスキップ

### 2. タグ付け処理
- Gemini APIに各記事タイトルを送信
- 階層タグ（tech/ai, tech/web, cryptography など）を自動生成
- 1記事につき1-3個のタグを付与
- 英語記事も日本語で処理し、日本語で要約を生成

#### プロンプト例
```
以下の記事タイトルに適切なタグを付けてください。
タグは階層構造で、tech/ai, tech/web, cryptography, business/startup などの形式です。
複数のタグがある場合はカンマ区切りで出力してください。
英語のタイトルの場合も日本語で理解し、適切なタグを付けてください。

タイトル: "{article_title}"
出力: タグのみを出力
```

### 3. タグ別グルーピング
- 同じタグを持つ記事をグループ化
- タグごとに記事リストを作成

### 4. 要約生成
- タグごとにGemini APIで要約を生成
- 各記事のタイトルとURLを含めた要約
- 英語記事も含めて日本語で要約を作成

#### プロンプト例
```
以下のタグ「{tag_name}」に関する記事一覧を要約してください。
記事数: {count}件
英語の記事タイトルも含まれる場合がありますが、すべて日本語で要約してください。

{article_list}

以下の形式で要約を作成してください：
- 主要なトピックや傾向
- 注目すべき記事の紹介
- 簡潔で分かりやすい日本語で
```

### 5. Obsidian REST API連携
- タグの階層構造に従ってフォルダとファイルを作成
- 例：`tech/ai` タグの場合 → `RSS/YYYY-MM-DD/tech/ai.md`
- 必要なフォルダは自動作成
- 記事が0件のタグはファイル作成しない

## Obsidian Local REST API エンドポイント

### ファイル作成
```http
POST https://127.0.0.1:27123/vault/{filename}
Headers:
  Authorization: Bearer {api_key}
  Content-Type: text/markdown

Body: {markdown_content}
```

### フォルダ作成
```http
PUT https://127.0.0.1:27123/vault/{folder_path}/
Headers:
  Authorization: Bearer {api_key}
```

### ファイル存在確認
```http
HEAD https://127.0.0.1:27123/vault/{filename}
Headers:
  Authorization: Bearer {api_key}
```

## 出力ファイル形式

### ファイル構造
```
ObsidianVault/
└── RSS/
    └── 2025-06-28/
        ├── tech/
        │   ├── ai.md
        │   └── web.md
        └── cryptography.md
```

### マークダウンファイル内容例
```markdown
---
date: 2025-06-28
tag: tech/ai
article_count: 5
created_by: RSS Feeder
tags: 
  - tech
  - ai
  - daily-digest
---

# AI関連記事まとめ (2025-06-28)

## 要約
今日のAI関連記事では、OpenAIの新機能リリースと、画像生成AIの進歩が主なトピックでした。特に注目すべきは...

## 記事一覧
- [OpenAI GPT-5の発表について](https://example.com/article1) - OpenAI
- [画像生成AIの最新動向](https://example.com/article2) - Tech News
- [AIエージェントの実用化事例](https://example.com/article3) - AI Weekly

## 詳細
### OpenAIの動向
GPT-5の発表により...

### 画像生成AI
DALL-E 3の改良版が...

---
*Generated by RSS Feeder on 2025-06-28*
```

## GAS実装の主要関数

### メイン関数
```javascript
function main() {
  try {
    const feeds = fetchAllFeeds();
    const taggedArticles = processWithGemini(feeds);
    const groupedByTag = groupArticlesByTag(taggedArticles);
    
    for (const [tag, articles] of Object.entries(groupedByTag)) {
      if (articles.length > 0) {
        const summary = generateSummary(tag, articles);
        const markdown = createMarkdown(tag, articles, summary);
        createObsidianFile(tag, markdown);
      }
    }
    
    console.log('RSS Feeder completed successfully');
  } catch (error) {
    console.error('RSS Feeder failed:', error);
  }
}
```

### 定期実行設定
```javascript
function createTrigger() {
  ScriptApp.newTrigger('main')
    .timeBased()
    .everyDays(1)
    .atHour(8)  // 毎日午前8時
    .create();
}
```

## エラーハンドリング
- フィード取得失敗: ログ出力してスキップ
- Gemini API失敗: ログ出力してスキップ
- Obsidian API失敗: ログ出力してリトライ（最大3回）
- 記事が0件の場合: ファイル作成せずにログ出力

## セキュリティ考慮事項
- Obsidian Local REST APIのAPIキーは適切に保護
- HTTPSエンドポイントの使用
- GASのPropertiesServiceでAPIキー管理

## GAS実行制限への対応
- **実行時間制限（6分）**: 大量フィード処理時はバッチ分割
- **API呼び出し制限**: Gemini API呼び出しを適切に分散
- **メモリ制限**: 大きなデータの一時保存を避ける

## 運用・メンテナンス
- GASのログでエラー監視
- 月1回程度でフィードリスト見直し
- Obsidian Local REST APIプラグインの稼働確認
- APIキーの定期更新
