# RSS Feeder - GitHub Actions + Node.js

## 概要
GitHub Actionsで毎日RSSフィードを取得し、Gemini APIでタグ付けと要約を行い、リポジトリにマークダウンファイルを作成するシステム

## 変更履歴
- **2025-06-28**: Google Apps ScriptからGitHub Actions + Node.jsに移行

## 前提条件

### GitHub環境
- GitHubリポジトリ
- GitHub Secrets設定：
  - `GEMINI_API_KEY`: Gemini API キー
  - `RSS_FEEDS`: RSSフィードURLのJSON配列

### Node.js環境
- Node.js 18以上
- 必要パッケージ: rss-parser, axios, date-fns, js-yaml

## システム構成

### 1. プロジェクト構造
```
personal-rss/
├── src/
│   ├── main.js          # メインスクリプト
│   ├── config.js        # 設定管理
│   ├── feedFetcher.js   # RSSフィード取得
│   ├── llmProcessor.js  # Gemini API処理
│   ├── obsidianAPI.js   # ファイル出力システム
│   └── utils.js         # ユーティリティ関数
├── .github/workflows/
│   └── rss-feeder.yml   # GitHub Actions ワークフロー
├── config/
│   └── feeds.json       # フィード設定（オプション）
├── output/              # 出力ディレクトリ
└── package.json         # Node.js依存関係
```

### 2. 設定管理（環境変数）
```bash
# 必須設定
export GEMINI_API_KEY="YOUR_GEMINI_API_KEY"
export RSS_FEEDS='["https://example.com/rss.xml","https://another-site.com/feed.xml"]'

# オプション設定
export OUTPUT_DIRECTORY="./output"
export DEBUG="false"
export TIMEZONE="Asia/Tokyo"
export MAX_RETRIES="3"
export GEMINI_REQUEST_DELAY="1000"
```

## 処理フロー

### 1. RSSフィード取得
- 環境変数からフィードURLリストを読み込み
- `axios`で各URLからRSSフィードを取得
- XMLの解析は`rss-parser`ライブラリを使用
- 取得失敗時はログ出力してスキップ

### 2. タグ付け処理
- Gemini APIに各記事タイトルを送信
- 階層タグ（tech/ai, tech/web, cryptography など）を自動生成
- 1記事につき1-3個のタグを付与
- 英語記事も日本語で処理し、日本語で要約を生成

#### プロンプト例
```
以下の記事タイトルに適切なタグを付けてください。
タグは階層構造で、tech/ai, tech/web, cryptography, business/startup などの形式です。
複数のタグがある場合はカンマ区切りで出力してください。
英語のタイトルの場合も日本語で理解し、適切なタグを付けてください。

タイトル: "{article_title}"
出力: タグのみを出力
```

### 3. タグ別グルーピング
- 同じタグを持つ記事をグループ化
- タグごとに記事リストを作成

### 4. 要約生成
- タグごとにGemini APIで要約を生成
- 各記事のタイトルとURLを含めた要約
- 英語記事も含めて日本語で要約を作成

#### プロンプト例
```
以下のタグ「{tag_name}」に関する記事一覧を要約してください。
記事数: {count}件
英語の記事タイトルも含まれる場合がありますが、すべて日本語で要約してください。

{article_list}

以下の形式で要約を作成してください：
- 主要なトピックや傾向
- 注目すべき記事の紹介
- 簡潔で分かりやすい日本語で
```

### 5. ファイル出力
- タグの階層構造に従ってフォルダとファイルを作成
- 例：`tech/ai` タグの場合 → `output/RSS/YYYY-MM-DD/tech/ai.md`
- 必要なフォルダは自動作成
- 記事が0件のタグはファイル作成しない
- GitHub Actionsでファイルをコミット・プッシュ

## セットアップ手順

### 1. 依存関係のインストール
```bash
npm install
```

### 2. GitHub Secrets設定
GitHub リポジトリの Settings > Secrets > Actions で以下を設定：
- `GEMINI_API_KEY`: Gemini API キー
- `RSS_FEEDS`: RSSフィードURLのJSON配列例 `["https://example.com/feed.xml"]`

### 3. ローカル実行
```bash
# 環境変数設定
export GEMINI_API_KEY="your-api-key"
export RSS_FEEDS='["https://example.com/feed.xml"]'

# 実行
npm start

# テストモード（限定記事数）
node src/main.js test

# ヘルスチェック
node src/main.js health
```

### 4. GitHub Actions設定
- ワークフローは毎日8:00 AM JST（23:00 UTC）に自動実行
- 手動実行も可能（Actions タブから）
- テストモードでの手動実行も可能

## 出力ファイル形式

### ファイル構造
```
output/
└── RSS/
    └── 2025-06-28/
        ├── index.md         # 日別インデックス
        ├── tech/
        │   ├── ai.md
        │   └── web.md
        └── cryptography.md
```

### マークダウンファイル内容例
```markdown
---
date: 2025-06-28
tag: tech/ai
article_count: 5
created_by: RSS Feeder
tags: 
  - tech
  - ai
  - daily-digest
---

# AI関連記事まとめ (2025-06-28)

## 要約
今日のAI関連記事では、OpenAIの新機能リリースと、画像生成AIの進歩が主なトピックでした。特に注目すべきは...

## 記事一覧
- [OpenAI GPT-5の発表について](https://example.com/article1) - OpenAI
- [画像生成AIの最新動向](https://example.com/article2) - Tech News
- [AIエージェントの実用化事例](https://example.com/article3) - AI Weekly

## 詳細
### OpenAIの動向
GPT-5の発表により...

### 画像生成AI
DALL-E 3の改良版が...

---
*Generated by RSS Feeder on 2025-06-28*
```

## Node.js実装の主要関数

### メイン関数
```javascript
async function run() {
  try {
    const articles = await feedFetcher.getAllArticles(true);
    const processedData = await llmProcessor.processArticles(articles);
    await fileOutput.generateOutput(processedData);
    
    console.log('RSS Feeder completed successfully');
  } catch (error) {
    console.error('RSS Feeder failed:', error);
  }
}
```

### GitHub Actions定期実行
```yaml
on:
  schedule:
    # 毎日8:00 AM JST (23:00 UTC)
    - cron: '0 23 * * *'
  workflow_dispatch: # 手動実行
```

## エラーハンドリング
- フィード取得失敗: ログ出力してスキップ
- Gemini API失敗: ログ出力してスキップ
- ファイル作成失敗: ログ出力してリトライ（最大3回）
- 記事が0件の場合: ファイル作成せずにログ出力

## セキュリティ考慮事項
- APIキーはGitHub Secretsで管理
- 秘密情報をソースコードに含めない
- 環境変数での設定管理

## 制限と考慮事項
- **GitHub Actions実行時間制限（6時間）**: 通常の使用では問題なし
- **Gemini API制限**: 適切な間隔でAPI呼び出し
- **Git LFS**: 大量のファイルが生成される場合は考慮

## 運用・メンテナンス
- GitHub Actionsログでエラー監視
- 月1回程度でフィードリスト見直し
- APIキーの定期更新
- 出力ファイルの定期的なクリーンアップ検討

## トラブルシューティング

### よくある問題
1. **GitHub Actions失敗**: GitHub Secretsの設定を確認
2. **Gemini API エラー**: APIキーとクォータを確認
3. **RSS フィード取得失敗**: フィードURLの有効性を確認
4. **タイムアウト**: GEMINI_REQUEST_DELAYを増加

### ログの確認
```bash
# ローカルでデバッグモード実行
export DEBUG=true
node src/main.js test
```
